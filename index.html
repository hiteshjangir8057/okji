<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Image Compressor</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
        }
        
        .upload-area {
            border: 2px dashed #3498db;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 30px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .upload-area:hover {
            background-color: #f0f8ff;
            border-color: #2980b9;
        }
        
        .upload-area i {
            font-size: 48px;
            color: #3498db;
            margin-bottom: 15px;
        }
        
        .upload-area p {
            margin-bottom: 10px;
            color: #7f8c8d;
        }
        
        .upload-area.active {
            border-color: #27ae60;
            background-color: #e8f5e9;
        }
        
        #fileInput {
            display: none;
        }
        
        .controls {
            margin-bottom: 30px;
        }
        
        .control-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        input[type="range"] {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            background: #ecf0f1;
            border-radius: 5px;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #3498db;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .quality-value {
            text-align: center;
            font-weight: bold;
            color: #3498db;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
            width: 100%;
            margin-top: 10px;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        .results {
            display: none;
            margin-top: 30px;
        }
        
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .image-box {
            text-align: center;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 5px;
        }
        
        .image-box img {
            max-width: 100%;
            max-height: 150px;
            border-radius: 5px;
        }
        
        .image-info {
            margin-top: 10px;
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .savings {
            text-align: center;
            font-size: 18px;
            margin: 20px 0;
            padding: 15px;
            background-color: #e8f5e9;
            border-radius: 5px;
            color: #27ae60;
            font-weight: 600;
        }
        
        .negative-savings {
            background-color: #ffebee;
            color: #e53935;
        }
        
        .download-btn {
            background-color: #27ae60;
        }
        
        .download-btn:hover {
            background-color: #219653;
        }
        
        .download-all-btn {
            background-color: #9c27b0;
        }
        
        .download-all-btn:hover {
            background-color: #7b1fa2;
        }
        
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .file-list {
            margin-top: 20px;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        
        .file-item:nth-child(odd) {
            background-color: #f9f9f9;
        }
        
        .preset-options {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .preset-btn {
            padding: 8px 15px;
            width: auto;
            font-size: 14px;
        }
        
        .a4-options {
            margin-top: 15px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }
        
        @media (max-width: 768px) {
            .image-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .preset-options {
                flex-direction: column;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
</head>
<body>
    <div class="container">
        <h1>Advanced Image Compressor</h1>
        
        <div class="upload-area" id="uploadArea">
            <i class="fas fa-cloud-upload-alt"></i>
            <h3>Drag & Drop Your Images Here</h3>
            <p>or</p>
            <button id="browseBtn">Browse Files</button>
            <input type="file" id="fileInput" accept="image/*" multiple>
            <div class="file-list" id="fileList"></div>
        </div>
        
        <div class="controls">
            <div class="preset-options">
                <button class="preset-btn" data-quality="90" data-width="2500" data-dpi="300">High Quality (90%)</button>
                <button class="preset-btn" data-quality="80" data-width="2000" data-dpi="300">Medium Quality (80%)</button>
                <button class="preset-btn" data-quality="60" data-width="1500" data-dpi="200">Web Quality (60%)</button>
            </div>
            
            <div class="control-group">
                <label for="qualityRange">Compression Quality</label>
                <input type="range" id="qualityRange" min="1" max="100" value="80">
                <div class="quality-value" id="qualityValue">80%</div>
            </div>
            
            <div class="control-group">
                <label for="maxWidth">Max Width (px)</label>
                <input type="range" id="maxWidth" min="100" max="5000" value="2000">
                <div class="quality-value" id="maxWidthValue">2000px</div>
            </div>
            
            <div class="a4-options">
                <h3>A4 Size Options</h3>
                <div class="control-group">
                    <label>
                        <input type="checkbox" id="a4Checkbox"> Convert to A4 Size (2480×3508 px @ 300DPI)
                    </label>
                </div>
                <div class="control-group">
                    <label for="targetKb">Target File Size (KB)</label>
                    <input type="range" id="targetKb" min="50" max="2000" value="500" disabled>
                    <div class="quality-value" id="targetKbValue">500KB</div>
                </div>
            </div>
            
            <button id="compressBtn" disabled>Compress Images</button>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p id="loadingText">Compressing images...</p>
        </div>
        
        <div class="results" id="results">
            <div class="image-grid" id="imageGrid"></div>
            
            <div class="savings" id="savings"></div>
            
            <button class="download-all-btn" id="downloadAllBtn">
                <i class="fas fa-file-archive"></i> Download All as ZIP
            </button>
        </div>
    </div>

    <script>
        // JSZip और FileSaver के बिना ZIP फंक्शनैलिटी
        function downloadAllAsZipAlternative() {
            if (compressedFiles.length === 0) return;
            
            if (compressedFiles.length === 1) {
                // सिंगल फाइल के लिए सीधे डाउनलोड
                downloadImage(compressedFiles[0].blob, `compressed_${compressedFiles[0].name}`);
                return;
            }
            
            // मल्टीपल फाइल्स के लिए एक-एक करके डाउनलोड
            alert('GitHub Pages पर ZIP फंक्शनैलिटी काम नहीं करती। फाइल्स अलग-अलग डाउनलोड करें।');
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const browseBtn = document.getElementById('browseBtn');
            const fileList = document.getElementById('fileList');
            const qualityRange = document.getElementById('qualityRange');
            const qualityValue = document.getElementById('qualityValue');
            const maxWidth = document.getElementById('maxWidth');
            const maxWidthValue = document.getElementById('maxWidthValue');
            const a4Checkbox = document.getElementById('a4Checkbox');
            const targetKb = document.getElementById('targetKb');
            const targetKbValue = document.getElementById('targetKbValue');
            const compressBtn = document.getElementById('compressBtn');
            const loading = document.getElementById('loading');
            const loadingText = document.getElementById('loadingText');
            const results = document.getElementById('results');
            const imageGrid = document.getElementById('imageGrid');
            const savings = document.getElementById('savings');
            const downloadAllBtn = document.getElementById('downloadAllBtn');
            const presetBtns = document.querySelectorAll('.preset-btn');
            
            // Variables
            let files = [];
            let compressedFiles = [];
            let totalOriginalSize = 0;
            let totalCompressedSize = 0;
            
            // Event listeners
            qualityRange.addEventListener('input', updateQualityValue);
            maxWidth.addEventListener('input', updateMaxWidthValue);
            targetKb.addEventListener('input', updateTargetKbValue);
            browseBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileSelection);
            a4Checkbox.addEventListener('change', toggleA4Options);
            compressBtn.addEventListener('click', compressAllImages);
            downloadAllBtn.addEventListener('click', downloadAllAsZipAlternative);
            
            // Preset buttons
            presetBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const quality = this.dataset.quality;
                    const width = this.dataset.width;
                    const dpi = this.dataset.dpi;
                    
                    qualityRange.value = quality;
                    maxWidth.value = width;
                    
                    updateQualityValue();
                    updateMaxWidthValue();
                });
            });
            
            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('active');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('active');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('active');
                if (e.dataTransfer.files.length) {
                    handleFileSelection({ target: { files: e.dataTransfer.files } });
                }
            });
            
            // Functions
            function updateQualityValue() {
                qualityValue.textContent = qualityRange.value + '%';
            }
            
            function updateMaxWidthValue() {
                maxWidthValue.textContent = maxWidth.value + 'px';
            }
            
            function updateTargetKbValue() {
                targetKbValue.textContent = targetKb.value + 'KB';
            }
            
            function toggleA4Options() {
                targetKb.disabled = !a4Checkbox.checked;
            }
            
            function handleFileSelection(event) {
                const newFiles = Array.from(event.target.files);
                
                // Filter only image files
                const imageFiles = newFiles.filter(file => file.type.match('image.*'));
                
                if (imageFiles.length === 0) {
                    alert('Please select image files only.');
                    return;
                }
                
                files = [...files, ...imageFiles];
                updateFileList();
                compressBtn.disabled = files.length === 0;
                results.style.display = 'none';
            }
            
            function updateFileList() {
                fileList.innerHTML = '';
                totalOriginalSize = 0;
                
                files.forEach((file, index) => {
                    totalOriginalSize += file.size;
                    
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.innerHTML = `
                        <span>${file.name} (${formatFileSize(file.size)})</span>
                        <button class="remove-btn" data-index="${index}">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    fileList.appendChild(fileItem);
                });
                
                // Add event listeners to remove buttons
                document.querySelectorAll('.remove-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const index = parseInt(this.dataset.index);
                        files.splice(index, 1);
                        updateFileList();
                        compressBtn.disabled = files.length === 0;
                    });
                });
            }
            
            async function compressAllImages() {
                if (files.length === 0) return;
                
                loading.style.display = 'block';
                results.style.display = 'none';
                imageGrid.innerHTML = '';
                compressedFiles = [];
                totalCompressedSize = 0;
                
                const quality = parseInt(qualityRange.value);
                const maxWidthValue = parseInt(maxWidth.value);
                const isA4 = a4Checkbox.checked;
                const targetSize = isA4 ? parseInt(targetKb.value) * 1024 : null;
                
                for (let i = 0; i < files.length; i++) {
                    loadingText.textContent = `Compressing images (${i+1}/${files.length})...`;
                    
                    const compressedFile = await compressImage(
                        files[i], 
                        quality, 
                        maxWidthValue,
                        isA4,
                        targetSize
                    );
                    
                    if (compressedFile) {
                        compressedFiles.push(compressedFile);
                        totalCompressedSize += compressedFile.blob.size;
                        displayCompressedImage(compressedFile, i);
                    }
                }
                
                showResults();
            }
            
            function displayCompressedImage(compressedFile, index) {
                const imageBox = document.createElement('div');
                imageBox.className = 'image-box';
                
                const img = document.createElement('img');
                img.src = URL.createObjectURL(compressedFile.blob);
                img.alt = `Compressed ${compressedFile.name}`;
                
                const info = document.createElement('div');
                info.className = 'image-info';
                info.textContent = `${compressedFile.name} (${formatFileSize(compressedFile.blob.size)})`;
                
                const downloadBtn = document.createElement('button');
                downloadBtn.className = 'download-btn';
                downloadBtn.innerHTML = '<i class="fas fa-download"></i> Download';
                downloadBtn.addEventListener('click', () => {
                    downloadImage(compressedFile.blob, `compressed_${compressedFile.name}`);
                });
                
                imageBox.appendChild(img);
                imageBox.appendChild(info);
                imageBox.appendChild(downloadBtn);
                
                imageGrid.appendChild(imageBox);
            }
            
            function showResults() {
                loading.style.display = 'none';
                results.style.display = 'block';
                
                const savingPercent = ((totalOriginalSize - totalCompressedSize) / totalOriginalSize * 100).toFixed(2);
                
                if (totalCompressedSize < totalOriginalSize) {
                    savings.textContent = `Saved ${savingPercent}% (${formatFileSize(totalOriginalSize - totalCompressedSize)}) across ${files.length} files`;
                    savings.className = 'savings';
                } else {
                    savings.textContent = `Increased by ${Math.abs(savingPercent)}% (${formatFileSize(totalCompressedSize - totalOriginalSize)}) across ${files.length} files`;
                    savings.className = 'savings negative-savings';
                }
            }
            
            function compressImage(file, quality, maxWidthValue, isA4, targetSize) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    
                    reader.onload = function(event) {
                        const img = new Image();
                        
                        img.onload = function() {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            
                            // Calculate dimensions
                            let width = img.width;
                            let height = img.height;
                            
                            if (isA4) {
                                // A4 size at 300 DPI: 2480×3508 pixels
                                const a4Width = 2480;
                                const a4Height = 3508;
                                
                                // Calculate scale to fit A4
                                const scale = Math.min(a4Width / width, a4Height / height);
                                width = Math.round(width * scale);
                                height = Math.round(height * scale);
                                
                                // Set canvas to A4 size with white background
                                canvas.width = a4Width;
                                canvas.height = a4Height;
                                ctx.fillStyle = 'white';
                                ctx.fillRect(0, 0, a4Width, a4Height);
                                
                                // Center image on A4 canvas
                                const x = (a4Width - width) / 2;
                                const y = (a4Height - height) / 2;
                                ctx.drawImage(img, x, y, width, height);
                            } else {
                                // Regular compression with max width
                                if (width > maxWidthValue) {
                                    height = Math.round((height * maxWidthValue) / width);
                                    width = maxWidthValue;
                                }
                                
                                canvas.width = width;
                                canvas.height = height;
                                ctx.drawImage(img, 0, 0, width, height);
                            }
                            
                            // For A4 with target size, use binary search to find optimal quality
                            if (isA4 && targetSize) {
                                findOptimalQuality(canvas, file.type, targetSize, (blob) => {
                                    resolve({
                                        name: file.name,
                                        blob: blob
                                    });
                                });
                            } else {
                                // Regular compression
                                canvas.toBlob(function(blob) {
                                    resolve({
                                        name: file.name,
                                        blob: blob
                                    });
                                }, file.type, quality / 100);
                            }
                        };
                        
                        img.src = event.target.result;
                    };
                    
                    reader.readAsDataURL(file);
                });
            }
            
            function findOptimalQuality(canvas, mimeType, targetSize, callback) {
                let minQuality = 1;
                let maxQuality = 100;
                let bestBlob = null;
                let iterations = 0;
                const maxIterations = 10;
                
                const tryQuality = (quality) => {
                    return new Promise((resolve) => {
                        canvas.toBlob(function(blob) {
                            resolve(blob);
                        }, mimeType, quality / 100);
                    });
                };
                
                const binarySearch = async () => {
                    iterations++;
                    
                    if (iterations > maxIterations) {
                        callback(bestBlob);
                        return;
                    }
                    
                    const midQuality = Math.round((minQuality + maxQuality) / 2);
                    const blob = await tryQuality(midQuality);
                    
                    if (!blob) {
                        callback(bestBlob);
                        return;
                    }
                    
                    if (blob.size <= targetSize) {
                        // If we're under target, try higher quality
                        bestBlob = blob;
                        minQuality = midQuality + 1;
                    } else {
                        // If we're over target, try lower quality
                        maxQuality = midQuality - 1;
                    }
                    
                    // If we haven't converged yet, continue searching
                    if (minQuality <= maxQuality) {
                        setTimeout(binarySearch, 0);
                    } else {
                        callback(bestBlob || blob);
                    }
                };
                
                binarySearch();
            }
            
            function downloadImage(blob, filename) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
        });
    </script>
</body>
</html>
